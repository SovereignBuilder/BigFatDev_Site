---
import Layout from "../../components/Layout.astro";
import { getCollection } from "astro:content";
import { BLOG_SECTIONS } from "../../lib/sections";
import { formatDate } from "../../lib/format";

const posts = (await getCollection("blog")).filter((post) => !post.data.draft);

const latestBySection = BLOG_SECTIONS.map((section) => {
  const latest = posts
    .filter((post) => post.data.section === section.title)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())[0];
  return { section, latest };
});
---

<Layout
  title="Blog"
  description="Three shelves: Dev Diary, Human-AI Engineering, Methodical Musings."
  currentPath="/blog"
>
  <section class="content">
    <h1>Blog</h1>
    <p class="meta">Three shelves. No tags. Each section has its own index.</p>
  </section>

  <section style="margin-top: 32px;">
    <div class="grid-3">
      {latestBySection.map(({ section, latest }) => (
        <div class="card">
          <h3>{section.title}</h3>
          <p>
            {section.title === "Dev Diary" &&
              "Notes from building: small decisions, steady practice, honest progress."}
            {section.title === "Human-AI Engineering" &&
              "Human-aligned systems, evaluation, tooling, and practical workflows."}
            {section.title === "Methodical Musings" &&
              "Internal process: discipline, mindset, and steady reflection."}
          </p>
          {latest ? (
            <div style="margin-top: 16px;">
              <div class="card" style="background: var(--surface-2);">
                <p class="meta" style="margin-top: 0;">Latest</p>
                <h4 style="margin: 8px 0 6px;">
                  <a href={`/blog/${section.slug}/${latest.slug}`}>{latest.data.title}</a>
                </h4>
                <p class="meta" style="margin: 0 0 12px;">
                  {formatDate(latest.data.date)}
                </p>
                <p>{latest.data.excerpt}</p>
              </div>
            </div>
          ) : (
            <p class="meta" style="margin-top: 16px;">No posts yet.</p>
          )}
          <div style="margin-top: 16px;">
            <a class="btn secondary" href={`/blog/${section.slug}`}>
              Open section
            </a>
          </div>
        </div>
      ))}
    </div>
  </section>
</Layout>
